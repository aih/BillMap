### Deployment

These instructions walk through installation of dependencies on a standard Ubuntu server. Installation for other Linux flavors will be similar.

#### Basic server set-up and log-in:

* Ensure that http, https and ssh ports are available.
* Store your private key (e.g. `mykey.pem`) and ensure it is readable (`chmod 400 mykey.pem`)
* Log in to the server from a terminal with ssh (e.g. `ssh -F /dev/null -i ./mykey.pem ubuntu@ec....compute-1.amazonaws.com`

#### Update server packages 

`sudo apt-get update`

#### Create flatgov directory

```bash
$ sudo mkdir /opt/flatgov
$ sudo chown ubuntu:ubuntu /opt/flatgov
```

#### Install Python, pyenv and python dependencies

See https://www.liquidweb.com/kb/how-to-install-pyenv-on-ubuntu-18-04/

* Install pyenv dependencies
```
$ sudo add-apt-repository "deb http://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe"
$ sudo apt-get update
$ sudo apt-get install -y make build-essential libssl-dev zlib1g-dev \
 libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev\
 libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev python-openssl\ libpcre3 libpcre3-dev
 $ sudo apt-get upgrade git
```

* Install pyenv:

`$ git clone https://github.com/pyenv/pyenv.git ~/.pyenv`

Then:

```bash
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n eval "$(pyenv init -)"\nfi' >> ~/.bashrc
```

and `source ~/.bashrc`

Load `.bashrc` from `.bash_profile` for interactive login

```bash
echo '# The following sources ~/.bashrc in the interactive login case,' >> ~/.bashrc
echo '# because .bashrc is not sourced for interactive login shells:' >> ~/.bashrc
echo 'case "$-" in *i*) if [ -r ~/.bashrc ]; then . ~/.bashrc; fi;; esac' >> ~/.bashrc
```

* Verify pyenv installation

`pyenv install --list`

* Install pyenv virtualenv

See https://github.com/pyenv/pyenv-virtualenv

```bash
$ git clone https://github.com/pyenv/pyenv-virtualenv.git $(pyenv root)/plugins/pyenv-virtualenv
```
* Auto-activate virtualenvs

`echo 'eval "$(pyenv virtualenv-init -)"' >> ~/.bash_profile`

* Restart shell to install pyenv virtualenv

`$ exec "$SHELL"`

* Install Python 3.8.3

`$ pyenv install 3.8.3`

* Create the `flatgov` virtualenv 

`pyenv virtualenv 3.8.3 flatgov`

* Upgrade pip

`pip install --upgrade pip`

#### Clone Flatgov repository

```bash
$ cd /opt/flatgov
$ git clone https://github.com/aih/FlatGov.git
```

Copy environment file and **edit the value of  SECRET_Key**:

```
$ cp /opt/flatgov/FlatGov/server_py/flatgov/.env-sample /opt/flatgov/FlatGov/server_py/flatgov/.env
```

#### Copy data

NOTE: TODO copy `congress` directory with processed data to `/opt/flatgov/FlatGov/server_py/congress`

The data generated by this repository's scripts resides in a `congress` directory. This is compressed with `tar -czf congress.tar.gz congress` and stored in an S3 bucket in AWS.

To download and unzip this data:

TODO: instructions
* Install the `aws cli` 

* Configure your user key and access token

These must provide access to the `s3://flatgov` bucket.

* Copy the data from AWS 

NOTE: It may be helpful to increase the concurrency by setting:
`aws configure set default.s3.max_concurrent_requests 20`

** Copy the `congress` directory
`$ nohup aws cp s3://flatgov/congress.tar.gz /opt/flatfov/congress.tar.gz &`

NOTE: This is copying ~12GB of data. It may take many hours (which is why it should be done in the background).

** Uncompress the `congress` directory

`$ cd /opt/flatgov`
`$ nohup tar xvzf congress.tar.gz &`

NOTE: This is uncompressing ~12GB of data. It may take about an hour and should be done in the background.

* Symlink the congress directory so it can be accessed in the Django app 

`$ ln -s /opt/flatgov/congress /opt/flatgov/FlatGov/flatgov/server_py/congress`

#### Install flatgov depencencies

Ensure that the `flatgov` virtual environment is activated:
`pyenv activate flatgov`

From the top level of this repository:
```bash
$ cd /opt/flatgov/FlatGov
$ pip install -r requirements.txt
$ pip install -r server_py/requirements.txt
```

#### Install and Configure Nginx 

* Install Nginx

`$sudo apt-get install -y nginx`

* Copy Nginx configuration into `/etc/nginx/sites-available/`

```bash
$ sudo cp /opt/flatgov/FlatGov/server_py/flatgov_nginx.conf /etc/nginx/sites-available/flatgov_nginx.conf 
```

* Symlink to this file from /etc/nginx/sites-enabled so nginx can see it:

`$ sudo ln -s /etc/nginx/sites-available/flatgov_nginx.conf /etc/nginx/sites-enabled/`

* Start Nginx

`$ sudo systemctl start nginx`

#### Serve with a wsgi server

##### Using waitress (compatible with Windows) 

See https://docs.pylonsproject.org/projects/waitress/en/stable/
and https://stackoverflow.com/a/38943785/628748

The `waitress` server will already be installed in your pyenv environment from `requirements.txt`. The `server_py/server.py` file can be used to serve the app from the command line with `python server.py` (within the `flatgov` pyenv environment).


##### Using uwsgi

NOTE: When I ran this from the command line, it tended to be unstable, with the service dying with a log like:

```
7 23:21:57 2020] GET /home/billsList.json => generated 1168162 bytes in 18 msecs (HTTP/1.1 200) 5 headers in 162 bytes (1 switches on core 0)
Gracefully killing worker 1 (pid: 15133)..
```
See https://uwsgi-docs.readthedocs.io/en/latest/tutorials/Django_and_nginx.html


```bash
$ cd /opt/flatgov/FlatGov/server_py/flatgov
$ nohup uwsgi --socket flatgov.sock --module flatgov.wsgi --chmod-socket=666 &`
```

* Restart Nginx

`$ sudo systemctl restart nginx`


TODO: set deployment to 'production' (i.e. remove debug info)

